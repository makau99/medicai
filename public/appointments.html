<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Appointments</title>
  <link rel="stylesheet" href="appointments.css">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="navbar">
    <div class="brand">
      <a href="../index.html">
        <img src="images/icon.png" class="icon" />
        <span class="name">MedicAI</span>
      </a>
    </div>

    <!-- Hamburger button (visible on mobile) -->
    <button class="menu-toggle" onclick="toggleMenu()">☰</button>

    <div class="nav-wrapper">
    <ul class="nav-links">
      <li><a href="triage.html">TRIAGE</a></li>
      <li><a href="maps.html">LOCATIONS</a></li>
      <li><a href="appointments.html"  class="active">APPOINTMENTS</a></li>
      <li><a href="dashboard.html">DASHBOARD</a></li>
      <li><a href="about.html">ABOUT</a></li>
    </ul>
    <button id="logbut" onclick="logout()">Log Out</button>
  </div>
  </div>


  <div class="content">
    <h1 class="section-title">Upcoming Appointments</h1>

    <div class="card-section">
      <div class="card-list" id="appointment-list"></div>
    </div>

    <div class="card-section">
      <h2>Book New Appointment</h2>
      <div class="glass-card" style="max-width: 400px; margin: auto;">
        <input id="title" type="text" placeholder="Appointment Title" class="input" />
        <input id="date" type="date" class="input" />
        <input id="time" type="time" class="input" />
        <select id="branch" class="input">
          <option disabled selected>Select Hospital Branch</option>
        </select>
        <button class="logbut" id="createBtn">Create</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ✅ AUTH CHECK AT PAGE LOAD
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      alert("You must be logged in to access this page.");
      window.location.href = 'login.html';
    }

    // ✅ Supabase setup
    const supabase = window.supabase.createClient(
      'https://zzwdnekgsdyxdzyhuafk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp6d2RuZWtnc2R5eGR6eWh1YWZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1ODM4MjcsImV4cCI6MjA2ODE1OTgyN30.Bw3UgVe_RjvX_HfxEn1HrPkzJ6N4KpIFahKe0lxMSmg'
    );

    // ✅ LOGOUT FUNCTION
    function logout() {
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }

    // ✅ Load appointments
    async function loadAppointments() {
      const today = new Date().toISOString().split('T')[0];
      const { data, error } = await supabase
        .from('appointments')
        .select('*')
        .eq('user_id', user.id)
        .gte('date', today)
        .order('date', { ascending: true });

      const list = document.getElementById('appointment-list');
      list.innerHTML = '';

      if (error) {
        console.error("Error fetching appointments:", error.message);
        return;
      }

      if (!data.length) {
        list.innerHTML = "<p>No upcoming appointments.</p>";
        return;
      }

      data.forEach(app => {
        const card = document.createElement('div');
        card.className = 'glass-card';
        card.innerHTML = `
          <h3>${app.title}</h3>
          <p><strong>Date:</strong> ${app.date}</p>
          <p><strong>Time:</strong> ${app.time}</p>
          <p><strong>Branch:</strong> ${app.branch}</p>
          <p><strong>Status:</strong> ${app.status}</p>
        `;
        list.appendChild(card);
      });
    }

    // ✅ Handle new appointment
    document.addEventListener('DOMContentLoaded', () => {
      loadAppointments();

      document.getElementById('createBtn').addEventListener('click', async () => {
        const title = document.getElementById('title').value.trim();
        const date = document.getElementById('date').value;
        const branch = document.getElementById('branch').value;
        const time = document.getElementById('time').value;

        if (!title || !date || !time || !branch) {
          alert("Please fill in all fields.");
          return;
        }
        const selectedDateTime = new Date(`${date}T${time}`);
        const now = new Date();
        if (selectedDateTime < now) {
          alert("You cannot book an appointment in the past.");
          return;
        }
        const { error } = await supabase.from('appointments').insert([{
          user_id: user.id,
          title,
          date,
          time,
          branch,
          status: 'Pending'
        }]);

        if (error) {
          alert("Error booking appointment: " + error.message);
          return;
        }

        document.getElementById('title').value = '';
        document.getElementById('time').value = '';
        document.getElementById('date').value = '';
        document.getElementById('branch').selectedIndex = 0;
        alert("Appointment booked!");
        loadAppointments();
      });

      // ✅ Load hospital branches from geojson
      const urlParams = new URLSearchParams(window.location.search);
      const preselectedHospital = urlParams.get('hospital');

      fetch("mygeodata/kenya_hospitals_per_county.geojson")
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById("branch");
          const names = new Set();
          data.features.forEach(f => {
            const name = f.properties?.Name;
            if (name && !names.has(name)) {
              names.add(name);
              const option = document.createElement("option");
              option.value = name;
              option.textContent = name;
              if (preselectedHospital && name.trim().toLowerCase() === preselectedHospital.trim().toLowerCase()) {
                option.selected = true;
              }
              select.appendChild(option);
            }
          });
        });
    });
  </script>
  <script>
    function toggleMenu() {
      const wrapper = document.querySelector('.nav-wrapper');
      wrapper.classList.toggle('show');
    }
  </script>
</body>
</html>
